#!/usr/bin/env python3

import sys
import os
import subprocess
import shutil

def run_script(script_name, audio_file):
    """Run a script with the audio file as argument."""
    script_path = os.path.join(os.path.dirname(__file__), script_name)

    if not os.path.exists(script_path):
        print(f"Error: Script {script_name} not found at {script_path}")
        sys.exit(1)

    print(f"\n=== Running {script_name} ===")
    result = subprocess.run([script_path, audio_file], check=True)
    return result.returncode == 0

def main():
    if len(sys.argv) != 2:
        print("Usage: process <audio_file>")
        sys.exit(1)

    audio_file = sys.argv[1]

    if not os.path.exists(audio_file):
        print(f"Error: Audio file not found: {audio_file}")
        sys.exit(1)

    # Get basename for final VTT creation
    base_name = os.path.splitext(os.path.basename(audio_file))[0]

    try:
        # Run the pipeline steps in order
        run_script("diarize", audio_file)
        run_script("cut-audio", audio_file)
        run_script("detect-language", audio_file)
        run_script("transcribe", audio_file)
        run_script("create-vtt", audio_file)

        # Copy VTT file to Desktop
        vtt_file = os.path.join("output", base_name, f"{base_name}.vtt")
        desktop_path = os.path.expanduser("~/Desktop/")
        if os.path.exists(vtt_file):
            shutil.copy(vtt_file, desktop_path)
            print(f"VTT file copied to {desktop_path}")
        else:
            print(f"Warning: VTT file not found at {vtt_file}")

        print(f"\n=== Pipeline completed successfully for {audio_file} ===")

    except subprocess.CalledProcessError as e:
        print(f"Error: Pipeline failed at step with exit code {e.returncode}")
        sys.exit(1)
    except KeyboardInterrupt:
        print("\nPipeline interrupted by user")
        sys.exit(1)

if __name__ == "__main__":
    main()
